import os
import time
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from webdriver_manager.chrome import ChromeDriverManager
from PIL import Image
import json
import cv2
import numpy as np


class ScreenshotCapture:
    def __init__(self, config_file="config/test_config.json"):
        """Screenshot capture sƒ±nƒ±fƒ±nƒ± ba≈ülatƒ±r"""
        self.config_file = config_file
        self.config = self._load_config()
        self.driver = None
        self.screenshots_dir = "screenshots"
        
        # Browser ayarlarƒ±nƒ± yapƒ±landƒ±r
        self.setup_browser()
    
    def _load_config(self):
        """Konfig√ºrasyon dosyasƒ±nƒ± y√ºkler"""
        try:
            with open(self.config_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        except FileNotFoundError:
            print(f"Hata: {self.config_file} dosyasƒ± bulunamadƒ±!")
            return {}
    
    def setup_browser(self):
        """Browser ayarlarƒ±nƒ± yapƒ±landƒ±rƒ±r"""
        try:
            from selenium import webdriver
            from selenium.webdriver.chrome.service import Service
            from webdriver_manager.chrome import ChromeDriverManager
            from selenium.webdriver.chrome.options import Options
            
            # Chrome options - minimal ayarlar
            chrome_options = Options()
            
            # Headless modu KESINLIKLE KAPAT
            # chrome_options.add_argument("--headless")
            
            # Temel ayarlar
            chrome_options.add_argument("--no-sandbox")
            chrome_options.add_argument("--disable-dev-shm-usage")
            chrome_options.add_argument("--window-size=1920,1080")
            
            # WebDriver'ƒ± ba≈ülat
            service = Service(ChromeDriverManager().install())
            self.driver = webdriver.Chrome(service=service, options=chrome_options)
            
            print("‚úÖ Chrome WebDriver ba≈üarƒ±yla ba≈ülatƒ±ldƒ±")
            
        except Exception as e:
            print(f"‚ùå WebDriver ba≈ülatma hatasƒ±: {e}")
            raise
    
    def capture_screenshot(self, page_config):
        """Belirtilen sayfanƒ±n ekran g√∂r√ºnt√ºs√ºn√º alƒ±r"""
        page_name = page_config['name']
        url = page_config['url']
        wait_time = page_config.get('wait_time', 5)  # Daha uzun bekleme
        
        print(f"üì∏ {page_name} sayfasƒ±nƒ±n ekran g√∂r√ºnt√ºs√º alƒ±nƒ±yor...")
        print(f"üåê URL: {url}")
        
        try:
            # Sayfaya git
            self.driver.get(url)
            
            # Google i√ßin √∂zel bekleme
            if 'google' in page_name.lower():
                print("üéØ Google sayfasƒ± i√ßin √∂zel bekleme uygulanƒ±yor...")
                wait_time = max(wait_time, 8)  # En az 8 saniye bekle
            
            # Sayfanƒ±n tamamen y√ºklenmesini bekle
            from selenium.webdriver.support.ui import WebDriverWait
            from selenium.webdriver.support import expected_conditions as EC
            from selenium.webdriver.common.by import By
            
            # Sayfa y√ºklenmesini bekle
            WebDriverWait(self.driver, 20).until(
                EC.presence_of_element_located((By.TAG_NAME, "body"))
            )
            
            # JavaScript'in √ßalƒ±≈ümasƒ±nƒ± bekle
            WebDriverWait(self.driver, 20).until(
                lambda driver: driver.execute_script("return document.readyState") == "complete"
            )
            
            # Sayfanƒ±n y√ºklenmesini bekle
            time.sleep(wait_time)
            
            # Google i√ßin ek kontrol
            if 'google' in page_name.lower():
                # Google logosunun y√ºklenip y√ºklenmediƒüini kontrol et
                try:
                    logo = self.driver.find_element(By.ID, "hplogo")
                    if logo.is_displayed():
                        print("‚úÖ Google logosu y√ºklendi")
                    else:
                        print("‚ö†Ô∏è Google logosu g√∂r√ºnm√ºyor, ek bekleme...")
                        time.sleep(3)
                except:
                    print("‚ö†Ô∏è Google logosu bulunamadƒ±, ek bekleme...")
                    time.sleep(3)
                
                # Gemini pop-up'ƒ±nƒ± kapat
                try:
                    # Pop-up'ƒ±n y√ºklenmesini bekle
                    time.sleep(3)
                    
                    # Daha kapsamlƒ± pop-up kapatma
                    self.driver.execute_script("""
                        // T√ºm pop-up'larƒ± bul ve kapat
                        const selectors = [
                            '[role="dialog"]',
                            '.gemini-popup',
                            '[data-testid*="popup"]',
                            '[data-testid*="modal"]',
                            '.modal',
                            '.popup',
                            '[aria-modal="true"]'
                        ];
                        
                        selectors.forEach(selector => {
                            const elements = document.querySelectorAll(selector);
                            elements.forEach(element => {
                                // Kapatma butonlarƒ±nƒ± bul
                                const closeButtons = element.querySelectorAll('button, [role="button"], .close, [aria-label*="close"], [aria-label*="kapat"]');
                                closeButtons.forEach(btn => {
                                    if (btn.textContent.toLowerCase().includes('close') || 
                                        btn.textContent.toLowerCase().includes('kapat') ||
                                        btn.getAttribute('aria-label')?.toLowerCase().includes('close') ||
                                        btn.getAttribute('aria-label')?.toLowerCase().includes('kapat')) {
                                        btn.click();
                                        console.log('Pop-up kapatƒ±ldƒ±:', selector);
                                    }
                                });
                            });
                        });
                        
                        // ESC tu≈üu sim√ºlasyonu
                        document.dispatchEvent(new KeyboardEvent('keydown', {key: 'Escape', keyCode: 27}));
                    """)
                    print("‚úÖ Pop-up kapatma i≈ülemi tamamlandƒ±")
                    time.sleep(1)
                        
                except Exception as e:
                    print(f"‚ö†Ô∏è Pop-up kapatma hatasƒ±: {e}")
                
                # Google i√ßin tema tutarlƒ±lƒ±ƒüƒ± saƒüla
                if "google" in page_config['url'].lower():
                    try:
                        self.driver.execute_script("""
                            // Google'da tema tutarlƒ±lƒ±ƒüƒ± saƒüla
                            console.log('Google tema kontrol√º ba≈ülatƒ±lƒ±yor...');
                            
                            // 1. CSS enjeksiyonu ile tema zorla
                            const style = document.createElement('style');
                            style.textContent = `
                                * {
                                    background-color: #ffffff !important;
                                    color: #000000 !important;
                                    border-color: #e0e0e0 !important;
                                }
                                body, html {
                                    background-color: #ffffff !important;
                                    color: #000000 !important;
                                }
                                [class*="dark"], [class*="Dark"] {
                                    background-color: #ffffff !important;
                                    color: #000000 !important;
                                }
                                [data-theme="dark"] {
                                    background-color: #ffffff !important;
                                    color: #000000 !important;
                                }
                            `;
                            document.head.appendChild(style);
                            
                            // 2. Body class'larƒ±nƒ± kontrol et
                            const body = document.body;
                            const html = document.documentElement;
                            
                            // 3. T√ºm tema class'larƒ±nƒ± temizle
                            body.classList.remove('dark', 'dark-theme', 'dark-mode', 'Dark', 'DarkTheme', 'DarkMode');
                            html.classList.remove('dark', 'dark-theme', 'dark-mode', 'Dark', 'DarkTheme', 'DarkMode');
                            
                            // 4. Light tema class'larƒ±nƒ± ekle
                            body.classList.add('light', 'light-theme', 'light-mode', 'Light', 'LightTheme', 'LightMode');
                            html.classList.add('light', 'light-theme', 'light-mode', 'Light', 'LightTheme', 'LightMode');
                            
                            // 5. CSS deƒüi≈ükenlerini zorla
                            document.documentElement.style.setProperty('--color-scheme', 'light');
                            document.documentElement.style.setProperty('--background-color', '#ffffff');
                            document.documentElement.style.setProperty('--text-color', '#000000');
                            document.documentElement.style.setProperty('color-scheme', 'light');
                            
                            // 6. Google'ƒ±n kendi tema ayarlarƒ±nƒ± kontrol et
                            const themeButtons = document.querySelectorAll('[aria-label*="theme"], [aria-label*="tema"], [data-testid*="theme"], [title*="theme"], [title*="tema"]');
                            themeButtons.forEach(btn => {
                                if (btn.textContent.toLowerCase().includes('light') || 
                                    btn.textContent.toLowerCase().includes('a√ßƒ±k') ||
                                    btn.getAttribute('aria-label')?.toLowerCase().includes('light') ||
                                    btn.getAttribute('aria-label')?.toLowerCase().includes('a√ßƒ±k') ||
                                    btn.getAttribute('title')?.toLowerCase().includes('light') ||
                                    btn.getAttribute('title')?.toLowerCase().includes('a√ßƒ±k')) {
                                    btn.click();
                                    console.log('Light tema se√ßildi');
                                }
                            });
                            
                            // 7. Meta tag'leri kontrol et
                            const metaTheme = document.querySelector('meta[name="color-scheme"]');
                            if (metaTheme) {
                                metaTheme.setAttribute('content', 'light');
                            }
                            
                            // 8. T√ºm elementleri zorla light tema yap
                            const allElements = document.querySelectorAll('*');
                            allElements.forEach(el => {
                                if (el.style.backgroundColor === 'rgb(0, 0, 0)' || 
                                    el.style.backgroundColor === 'black' ||
                                    el.style.color === 'rgb(255, 255, 255)' ||
                                    el.style.color === 'white') {
                                    el.style.backgroundColor = '#ffffff';
                                    el.style.color = '#000000';
                                }
                            });
                            
                            console.log('Google tema kontrol√º tamamlandƒ±');
                        """)
                        print("‚úÖ Google tema tutarlƒ±lƒ±ƒüƒ± saƒülandƒ±")
                        time.sleep(3)  # Daha uzun bekleme
                    except Exception as e:
                        print(f"‚ö†Ô∏è Google tema kontrol√º hatasƒ±: {e}")
            
            # Ekran g√∂r√ºnt√ºs√º al
            screenshot_path = f"{self.screenshots_dir}/{page_name}.png"
            self.driver.save_screenshot(screenshot_path)
            
            print(f"‚úÖ Ekran g√∂r√ºnt√ºs√º kaydedildi: {screenshot_path}")
            return screenshot_path
            
        except Exception as e:
            print(f"‚ùå Ekran g√∂r√ºnt√ºs√º alma hatasƒ±: {e}")
            return None
    
    def capture_baseline_screenshots(self):
        """T√ºm test sayfalarƒ±nƒ±n referans ekran g√∂r√ºnt√ºlerini alƒ±r"""
        print("üéØ Referans ekran g√∂r√ºnt√ºleri alƒ±nƒ±yor...")
        
        # Baseline klas√∂r√ºn√º olu≈ütur
        baseline_dir = "baseline"
        os.makedirs(baseline_dir, exist_ok=True)
        
        # screenshots_dir'i ge√ßici olarak baseline olarak ayarla
        original_screenshots_dir = self.screenshots_dir
        self.screenshots_dir = baseline_dir
        
        results = []
        
        for page_config in self.config.get('test_pages', []):
            screenshot_path = self.capture_screenshot(page_config)
            if screenshot_path:
                results.append({
                    'page_name': page_config['name'],
                    'screenshot_path': screenshot_path,
                    'url': page_config['url']
                })
        
        # screenshots_dir'i geri al
        self.screenshots_dir = original_screenshots_dir
        
        print(f"‚úÖ {len(results)} adet referans ekran g√∂r√ºnt√ºs√º alƒ±ndƒ±")
        return results
    
    def capture_test_screenshots(self):
        """Test sƒ±rasƒ±nda ekran g√∂r√ºnt√ºleri alƒ±r"""
        print("üß™ Test ekran g√∂r√ºnt√ºleri alƒ±nƒ±yor...")
        
        # Screenshots klas√∂r√ºn√º olu≈ütur
        screenshots_dir = "screenshots"
        os.makedirs(screenshots_dir, exist_ok=True)
        self.screenshots_dir = screenshots_dir # screenshots_dir'i sƒ±nƒ±f deƒüi≈ükenine ata
        
        results = []
        
        for page_config in self.config.get('test_pages', []):
            screenshot_path = self.capture_screenshot(page_config)
            if screenshot_path:
                results.append({
                    'page_name': page_config['name'],
                    'screenshot_path': screenshot_path,
                    'url': page_config['url']
                })
        
        print(f"‚úÖ {len(results)} adet test ekran g√∂r√ºnt√ºs√º alƒ±ndƒ±")
        return results
    
    def close_driver(self):
        """WebDriver'ƒ± kapatƒ±r"""
        if self.driver:
            self.driver.quit()
            print("üîí WebDriver kapatƒ±ldƒ±")


def main():
    """Ana fonksiyon - referans ekran g√∂r√ºnt√ºleri alƒ±r"""
    capture = ScreenshotCapture()
    
    try:
        # Referans ekran g√∂r√ºnt√ºlerini al
        results = capture.capture_baseline_screenshots()
        
        print("\nüìä Sonu√ßlar:")
        for result in results:
            print(f"  - {result['page_name']}: {result['screenshot_path']}")
            
    except Exception as e:
        print(f"‚ùå Hata: {e}")
    finally:
        capture.close_driver()


if __name__ == "__main__":
    main() 